{"version":3,"file":"websocket-effects-patch.js","sourceRoot":"","sources":["websocket-effects-patch.ts"],"names":[],"mappings":"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","sourcesContent":["type ElmEffectsTask = {\n    functionPath: string,\n    functionArguments: any[],\n}\n\ndeclare interface XMLHttpRequest {\n    isElmEffectsTask: boolean;\n    patchedForElmEffects: boolean;\n    elmEffectsTask: ElmEffectsTask;\n}\n\n(function (window: Window): void {\n    const EFFECTS_TASK_URL = \"https://elm-effects-task.flexidao.com/\";\n    const EFFECTS_TASK_URL_LENGTH = EFFECTS_TASK_URL.length;\n\n    function resolve(obj: any, path: string) {\n        return path.split('.').reduce((o: any, i: string) => o[i], obj)\n    }\n\n    const setResponseOf = (xhr: XMLHttpRequest, status: number, result: any): void => {\n        Object.defineProperty(xhr, \"status\", {\n            configurable: true,\n            get: () => status\n        });\n        Object.defineProperty(xhr, \"response\", {\n            configurable: true,\n            get: () => JSON.stringify(result)\n        });\n        const loadEvent = new Event(\"load\");\n        xhr.dispatchEvent(loadEvent);\n    };\n\n    const patchedOpen =\n        function (originalOpen: Function) {\n            return function (this: XMLHttpRequest, method: string, url: string, async?: boolean, username?: string | null, password?: string | null): void {\n                if (url.startsWith(EFFECTS_TASK_URL)) {\n                    const functionPath = url.substring(EFFECTS_TASK_URL_LENGTH);\n                    this.isElmEffectsTask = true;\n                    this.elmEffectsTask = {\n                        functionPath: functionPath,\n                        functionArguments: [],\n                    }\n                } else {\n                    // This is important, since XMLHttpRequest might be reused.\n                    this.isElmEffectsTask = false;\n                    originalOpen.apply(this, arguments);\n                }\n            };\n        };\n\n    const patchedSetRequestHeader =\n        function (originalSetRequestHeader: Function) {\n            return function (this: XMLHttpRequest, name: string, value: string): void {\n                if (this.isElmEffectsTask) {\n                    // pass\n                } else {\n                    originalSetRequestHeader.apply(this, arguments);\n                }\n            };\n        };\n\n    const patchedSend =\n        function (originalSend: Function) {\n            return function (this: XMLHttpRequest, body?: Document | BodyInit | null): void {\n                if (this.isElmEffectsTask) {\n                    const functionPath = this.elmEffectsTask.functionPath;\n                    var functionArguments = [];\n                    if (typeof body === \"string\") {\n                        functionArguments = body\n                            ? JSON.parse(body)\n                            : [];\n                    }\n\n                    if (!Array.isArray(functionArguments)) {\n                        const errorMessage = `ElmEffectsTask: expected array of arguments. Got '${functionArguments}'.`;\n                        setResponseOf(this, 404, errorMessage);\n                        console.error(errorMessage);\n                    }\n\n                    var resolvedFunction: any | undefined;\n                    try {\n                        resolvedFunction = resolve(window, functionPath);\n                    } catch (e) {\n                        const errorMessage = `ElmEffectsTask: failed to resolve path '${functionPath}'.`;\n                        setResponseOf(this, 404, errorMessage);\n                        console.error(errorMessage);\n                        console.error(e);\n                    }\n\n                    if (resolvedFunction) {\n                        const typeOfResolvedFunction: string = typeof resolvedFunction;\n\n                        if (typeOfResolvedFunction === \"function\") {\n                            const result = resolvedFunction.apply(window, functionArguments);\n                            setResponseOf(this, 200, result);\n                        } else {\n                            const errorMessage = `ElmEffectsTask: '${functionPath}' does not resolve to a function. It resolves to '${typeOfResolvedFunction}'.`;\n                            setResponseOf(this, 404, errorMessage);\n                            console.error(errorMessage);\n                        }\n                    } else {\n                        const errorMessage = `ElmEffectsTask: '${functionPath}' resolves to undefined, null, false or equivalent.`;\n                        setResponseOf(this, 404, errorMessage);\n                        console.error(errorMessage);\n                    }\n                } else {\n                    originalSend.apply(this, arguments);\n                }\n            };\n        };\n\n    const patch = () => {\n        // @ts-ignore\n        const exists = XMLHttpRequest.prototype.patchedForElmEffects;\n        if (exists) {\n            console.warn(\"Websockets already patched for elm effects.\");\n            return;\n        }\n\n        console.log(\"Patching websockets for side effects...\");\n\n        // Patch open\n        const originalOpen = XMLHttpRequest.prototype.open;\n        XMLHttpRequest.prototype.open = patchedOpen(originalOpen);\n\n        // Patch send\n        const originalSend = XMLHttpRequest.prototype.send;\n        XMLHttpRequest.prototype.send = patchedSend(originalSend);\n\n        // Patch setRequestHeader\n        const originalSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;\n        XMLHttpRequest.prototype.setRequestHeader = patchedSetRequestHeader(originalSetRequestHeader);\n\n        // Store success.\n        // @ts-ignore\n        XMLHttpRequest.prototype.patchedForElmEffects = true;\n    };\n\n    patch();\n})(window);"]}